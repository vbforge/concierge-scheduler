<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head(title='Statistics')}"></head>

<body>
<!-- Navbar -->
<nav th:replace="~{fragments/layout :: navbar}"></nav>

<div class="container-fluid content-wrapper">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h2 class="mb-0">
                                <i class="fas fa-chart-bar"></i> Statistics & Reports
                            </h2>
                            <p class="text-muted mb-0">
                                <span th:text="${monthName + ' ' + year}">November 2025</span>
                            </p>
                        </div>

                        <div class="btn-group mt-2 mt-md-0">
                            <!-- Previous Month -->
                            <a th:href="@{/statistics/{year}/{month}(year=${prevYear},month=${prevMonth})}"
                               class="btn btn-outline-primary">
                                <i class="fas fa-chevron-left"></i>
                            </a>

                            <!-- Current Month -->
                            <a href="/statistics" class="btn btn-outline-primary">
                                <i class="fas fa-home"></i> Current
                            </a>

                            <!-- Next Month -->
                            <a th:href="@{/statistics/{year}/{month}(year=${nextYear},month=${nextMonth})}"
                               class="btn btn-outline-primary">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    <div th:replace="~{fragments/layout :: messages}"></div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary" th:text="${totalShifts}">30</h3>
                    <p class="text-muted mb-0">
                        <i class="fas fa-calendar-check"></i> Total Shifts
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success" th:text="${averageShifts}">10.0</h3>
                    <p class="text-muted mb-0">
                        <i class="fas fa-chart-line"></i> Average per Concierge
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info" th:text="${concierges.size()}">3</h3>
                    <p class="text-muted mb-0">
                        <i class="fas fa-users"></i> Active Concierges
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">
                        <span th:text="${maxShifts}">12</span>
                        <small class="text-muted" style="font-size: 0.5em;">max</small>
                    </h3>
                    <p class="text-muted mb-0">
                        <i class="fas fa-trophy"></i> Most Active
                    </p>
                    <small class="text-muted" th:text="${mostActive}">Alice</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Shift Distribution Chart -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> Shift Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="shiftChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table"></i> Detailed Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Concierge</th>
                                <th>Color</th>
                                <th>Shifts This Month</th>
                                <th>Percentage</th>
                                <th>Total All Time</th>
                                <th>Status</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="concierge : ${concierges}">
                                <td>
                                    <i class="fas fa-user"></i>
                                    <strong th:text="${concierge.name}">Alice</strong>
                                </td>
                                <td>
                                            <span class="badge"
                                                  th:style="'background-color: ' + ${concierge.color.hexCode}"
                                                  th:text="${concierge.color.displayName}">
                                                Blue
                                            </span>
                                </td>
                                <td>
                                            <span class="badge bg-info"
                                                  th:text="${shiftCounts.get(concierge.name) ?: 0}">
                                                10
                                            </span>
                                </td>
                                <td>
                                    <!--<div class="progress" style="height: 20px;">
                                        <div class="progress-bar"
                                             role="progressbar"
                                             th:style="'width: ' + (totalShifts > 0 ? (shiftCounts.get(concierge.name) ?: 0) * 100.0 / totalShifts : 0) + '%; background-color: ' + ${concierge.color.hexCode}"
                                             th:attr="aria-valuenow=${shiftCounts.get(concierge.name) ?: 0},aria-valuemin=0,aria-valuemax=${totalShifts}">
                                            <span th:text="${totalShifts > 0 ? #numbers.formatDecimal((shiftCounts.get(concierge.name) ?: 0) * 100.0 / totalShifts, 1, 1) + '%' : '0%'}">33.3%</span>
                                        </div>
                                    </div>-->
                                    <div th:with="percentage=${totalShifts > 0 ? (shiftCounts.get(concierge.name) ?: 0) * 100.0 / totalShifts : 0}">
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar"
                                                 role="progressbar"
                                                 th:style="'width:' + percentage + '%; background-color:' + concierge.color.hexCode"
                                                 th:attr="aria-valuenow=${shiftCounts.get(concierge.name) ?: 0},
                      aria-valuemin=0,
                      aria-valuemax=${totalShifts}">
                                                <span th:text="${#numbers.formatDecimal(percentage, 1, 1) + '%'}">33.3%</span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                            <span class="badge bg-secondary"
                                                  th:text="${concierge.totalShiftCount}">
                                                100
                                            </span>
                                </td>
                                <td>
                                            <span th:if="${concierge.active}" class="badge bg-success">
                                                <i class="fas fa-check-circle"></i> Active
                                            </span>
                                    <span th:unless="${concierge.active}" class="badge bg-warning">
                                                <i class="fas fa-pause-circle"></i> Inactive
                                            </span>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Indicators -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-star"></i> Most Active
                    </h5>
                </div>
                <div class="card-body text-center">
                    <h2 th:text="${mostActive ?: 'N/A'}">Alice</h2>
                    <p class="text-muted mb-0">
                        <strong th:text="${maxShifts}">12</strong> shifts this month
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> Least Active
                    </h5>
                </div>
                <div class="card-body text-center">
                    <h2 th:text="${leastActive ?: 'N/A'}">Carol</h2>
                    <p class="text-muted mb-0">
                        <strong th:text="${minShifts}">8</strong> shifts this month
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer th:replace="~{fragments/layout :: footer}"></footer>

<!-- Scripts -->
<th:block th:replace="~{fragments/layout :: scripts}"></th:block>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Statistics-specific Script -->
<script th:inline="javascript">
    /*<![CDATA[*/

    // Get data from Thymeleaf
    const chartLabels = /*[[${chartData.labels}]]*/ [];
    const chartValues = /*[[${chartData.data}]]*/ [];

    // Get concierge colors
    const concierges = /*[[${concierges}]]*/ [];
    const colors = concierges.map(c => c.color.hexCode);

    // Create chart
    const ctx = document.getElementById('shiftChart').getContext('2d');
    const shiftChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Shifts',
                data: chartValues,
                backgroundColor: colors,
                borderColor: colors,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Shifts per Concierge',
                    font: {
                        size: 16
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    /*]]>*/
</script>
</body>
</html>